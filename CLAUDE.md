# PromptPilot — Claude Code Context

## What This Project Is
A prompt enhancement tool. Users paste a rough prompt, the app uses Anthropic Claude to structure and improve it (Role / Goal / Output format / Constraints sections), and returns a polished version with improvements, assumptions, and follow-up questions.

---

## Tech Stack

| Layer | Tech |
|-------|------|
| Frontend | React 19, React Router 7, Zustand 5, Tailwind CSS 4, Vite 6 |
| UI components | Radix UI primitives + custom components in `src/app/components/` |
| Backend | Supabase Edge Functions (Deno + Hono) |
| AI | Anthropic Claude (`claude-sonnet-4-6` via REST API) |
| Auth / DB | Supabase (`nkdohzkcyovwuktdhmyd`) |

---

## Project Structure

```
PromptPilot/
├── src/
│   ├── app/
│   │   ├── App.tsx             # Root — global onAuthStateChange listener
│   │   ├── pages/              # Route-level components
│   │   │   └── AuthPage.tsx    # /login — Google, Apple, email/password
│   │   ├── components/         # Shared UI (Button, Card, Modal, Toast…)
│   │   ├── state/
│   │   │   └── pilotStore.ts   # Zustand store (persisted)
│   │   ├── utils/
│   │   │   ├── workflowApi.ts  # Workflow engine client + SAMPLE_WORKFLOW
│   │   │   └── demoData.ts
│   │   └── routes.tsx
│   └── utils/
│       └── supabase/
│           └── client.ts       # Supabase client (auth options configured)
├── supabase/
│   ├── migrations/
│   │   └── 20260223000000_saved_prompts.sql
│   └── functions/
│       ├── server/             # Main enhance + signup endpoint
│       │   └── index.ts
│       ├── workflow-engine/    # Multi-step AI chaining engine
│       │   └── index.ts
│       ├── enhance-prompt/
│       ├── mint-token/
│       └── redeem-token/
├── utils/
│   └── supabase/
│       └── info.tsx            # projectId + publicAnonKey (autogenerated)
└── CLAUDE.md
```

---

## Supabase Edge Functions

### `server` — `/make-server-e52adb92/enhance`
The main enhancement endpoint. Business logic:
- **Intent detection**: keyword rules → override → default (`tech`)
- **Level resolution**: `standard` / `advanced` / `expert` based on input complexity
- **Token policies**: per-level temperature + max_tokens config
- **Quality check**: verifies enhanced_prompt has Role/Goal/Output format/Constraints sections + ≥3 improvements
- **Retry logic**: one automatic retry with stricter system prompt if quality check fails
- **Fallback**: static fallback response if API key missing or both attempts fail
- **Model**: `claude-sonnet-4-6` (env: `ANTHROPIC_MODEL`)

Also exposes `POST /make-server-e52adb92/signup`.

### `workflow-engine` — `/workflow-engine/execute`
Chains multiple Claude calls. Each step interpolates `{{variable}}` placeholders using outputs from previous steps.

Key functions:
- `interpolateTemplate(template, context)` — replaces `{{key}}` or throws if key missing
- `callClaude(prompt, options)` — single Anthropic API call, returns text string
- `executeWorkflow(workflow, inputs)` — runs steps sequentially, stops on first failure

Response includes `outputs` (all step results) and `trace` (per-step status + latency).

Also exposes `GET /workflow-engine/health`.

**Deploy command**: `supabase functions deploy workflow-engine`

---

## Auth Architecture

Auth state is managed globally in `App.tsx` via `supabase.auth.onAuthStateChange`. This fires on:
- Page load with existing session (including post-OAuth redirect)
- Login / logout
- Token refresh

On session start it calls `setAuth()` then fetches and hydrates `saved_prompts` from Supabase.
On session end it calls `logout()`.

**OAuth flow**: `signInWithOAuth({ provider, options: { redirectTo: origin + '/auth/callback' } })` — browser redirects to provider, then back to `/auth/callback`. That page subscribes to `onAuthStateChange` and navigates to `/app` once the session is established. The Supabase client detects the token in the URL automatically (`detectSessionInUrl: true`).

**To enable OAuth providers**: Supabase Dashboard → Authentication → Providers → enable Google and Apple with their respective credentials. Also add allowed Redirect URLs (including `http://localhost:5173` for dev).

---

## Database

### `saved_prompts` table
| Column | Type | Notes |
|--------|------|-------|
| `id` | uuid PK | matches `SavedPrompt.id` in store |
| `user_id` | uuid FK → auth.users | cascade delete |
| `title` | text | |
| `input` | text | |
| `enhanced_prompt` | text | camelCase `enhancedPrompt` in store |
| `improvements` | jsonb | string array |
| `structure` | text | nullable |
| `created_at` | timestamptz | |
| `last_used` | timestamptz | nullable |

RLS enabled — users can only read/write their own rows (`auth.uid() = user_id`).

Migration: `supabase/migrations/20260223000000_saved_prompts.sql`
Run with: `supabase db push`

---

## Frontend State (`pilotStore.ts`)

Persisted to `localStorage` via Zustand `persist`. Key slices:

```ts
usage:     { enhanceCount, copyCount, lastUsedAtISO }
flags:     { hasSeenImprovementsOnce, dismissedExtensionNudge… }
account:   { isAuthed, tier, userId, email, userName }
prompts:   { saved: SavedPrompt[], lastPromptId }
savedWorkflowResults: WorkflowResult[]   // max 10, newest first
```

Key actions:
- `savePrompt` — writes to local store + fire-and-forget upsert to `saved_prompts` when authed
- `hydratePrompts` — replaces local saved prompts with data fetched from Supabase on login
- `saveWorkflowResult`, `setAuth`, `logout`, `incrementEnhance`

---

## Key Routes

| Path | Component | Notes |
|------|-----------|-------|
| `/` | `LandingPage` | Main enhance flow (inline API call) |
| `/login` | `AuthPage` | Google, Apple, email/password |
| `/processing` | `ProcessingPage` | Animation only, navigates to `/results` |
| `/app/workflow-processing` | `ProcessingPage useWorkflow` | Calls workflow engine, reads `location.state.input` |
| `/app` | `CommandCenter` | Authenticated app shell |
| `/app/input` | `PromptInputPage` | |
| `/app/library` | `PromptLibrary` | |
| `/app/history` | `HistoryPage` | |
| `/app/workflows` | redirects to `/app` | Placeholder |

---

## Triggering the Workflow Flow

```ts
navigate('/app/workflow-processing', { state: { input: 'your raw prompt' } });
// Result stored in usePilotStore.savedWorkflowResults[0] after completion
```

---

## Environment Variables (Supabase Secrets)

```
ANTHROPIC_API_KEY    — required by both server and workflow-engine functions
ANTHROPIC_MODEL      — optional, defaults to claude-sonnet-4-6
```

Set with: `supabase secrets set ANTHROPIC_API_KEY=sk-ant-...`

---

## What's Already Done
- [x] Migrated `server` function from OpenAI to Anthropic Claude
- [x] Built `workflow-engine` function (multi-step chaining)
- [x] `WorkflowResult` type + `saveWorkflowResult` action in store
- [x] `src/app/utils/workflowApi.ts` with `executeWorkflow` + `SAMPLE_WORKFLOW`
- [x] `ProcessingPage` updated with `useWorkflow` prop
- [x] `/app/workflow-processing` route wired up
- [x] Supabase Auth: Google OAuth, Apple OAuth, email/password (`/login`)
- [x] Global auth state listener in `App.tsx` (`onAuthStateChange`)
- [x] `saved_prompts` table with RLS (migration applied)
- [x] `savePrompt` syncs to Supabase DB when authenticated
- [x] `hydratePrompts` loads DB prompts into store on login

---

## What's Next

### Immediate
- [ ] Enable Google + Apple OAuth providers in Supabase Dashboard (Authentication → Providers)
- [ ] Add redirect URLs in Supabase Dashboard (Authentication → URL Configuration)
- [ ] Surface workflow results in the UI (a `WorkflowResultsPage` or panel in `HistoryPage`)
- [ ] Wire a trigger in the app that navigates to `/app/workflow-processing` with real input
- [ ] Add error state to `ProcessingPage` (currently always navigates to `/results` even on failure)

### Medium Term
- [ ] Store workflow definitions in Supabase DB (not hardcoded)
- [ ] SSE streaming — show each step result as it arrives instead of waiting for all
- [ ] Let Claude classify intent instead of keyword rules in `server/index.tsx`
- [ ] Workflow builder UI (drag/drop steps, custom templates)

### Upgrade Path
```
Prototype (now)           → Full Architecture (later)
─────────────────────────────────────────────────────
Hardcoded workflows       → Workflows stored in Supabase DB
SessionStorage state      → Proper workflow history/library
Single enhance call       → Multi-step chain execution
No streaming              → SSE streaming per step
Manual intent detection   → Claude classifies intent itself
```
