# PromptPilot — Claude Code Context

## What This Project Is
A prompt enhancement tool. Users paste a rough prompt, the app uses Anthropic Claude to structure and improve it (Role / Goal / Output format / Constraints sections), and returns a polished version with improvements, assumptions, and follow-up questions.

---

## Tech Stack

| Layer | Tech |
|-------|------|
| Frontend | React 19, React Router 7, Zustand 5, Tailwind CSS 4, Vite 6 |
| UI components | Radix UI primitives + custom components in `src/app/components/` |
| Backend | Supabase Edge Functions (Deno + Hono) |
| AI | Anthropic Claude (`claude-sonnet-4-6` via REST API) |
| Auth / DB | Supabase (`nkdohzkcyovwuktdhmyd`) |

---

## Project Structure

```
PromptPilot/
├── src/
│   ├── app/
│   │   ├── pages/          # Route-level components
│   │   ├── components/     # Shared UI (Button, Card, Modal, Toast…)
│   │   ├── state/
│   │   │   └── pilotStore.ts   # Zustand store (persisted)
│   │   ├── utils/
│   │   │   ├── workflowApi.ts  # Workflow engine client + SAMPLE_WORKFLOW
│   │   │   └── demoData.ts
│   │   └── routes.tsx
│   └── ...
├── supabase/
│   └── functions/
│       ├── server/             # Main enhance + signup endpoint
│       │   └── index.tsx
│       ├── workflow-engine/    # Multi-step AI chaining engine
│       │   └── index.ts
│       ├── enhance-prompt/
│       ├── mint-token/
│       └── redeem-token/
├── utils/
│   └── supabase/
│       └── info.tsx            # projectId + publicAnonKey (autogenerated)
└── CLAUDE.md
```

---

## Supabase Edge Functions

### `server` — `/make-server-e52adb92/enhance`
The main enhancement endpoint. Business logic:
- **Intent detection**: keyword rules → override → default (`tech`)
- **Level resolution**: `standard` / `advanced` / `expert` based on input complexity
- **Token policies**: per-level temperature + max_tokens config
- **Quality check**: verifies enhanced_prompt has Role/Goal/Output format/Constraints sections + ≥3 improvements
- **Retry logic**: one automatic retry with stricter system prompt if quality check fails
- **Fallback**: static fallback response if API key missing or both attempts fail
- **Model**: `claude-sonnet-4-6` (env: `ANTHROPIC_MODEL`)

Also exposes `POST /make-server-e52adb92/signup`.

### `workflow-engine` — `/workflow-engine/execute`
Chains multiple Claude calls. Each step interpolates `{{variable}}` placeholders using outputs from previous steps.

Key functions:
- `interpolateTemplate(template, context)` — replaces `{{key}}` or throws if key missing
- `callClaude(prompt, options)` — single Anthropic API call, returns text string
- `executeWorkflow(workflow, inputs)` — runs steps sequentially, stops on first failure

Response includes `outputs` (all step results) and `trace` (per-step status + latency).

Also exposes `GET /workflow-engine/health`.

**Deploy command**: `supabase functions deploy workflow-engine`

---

## Frontend State (`pilotStore.ts`)

Persisted to `localStorage` via Zustand `persist`. Key slices:

```ts
usage:     { enhanceCount, copyCount, lastUsedAtISO }
flags:     { hasSeenImprovementsOnce, dismissedExtensionNudge… }
account:   { isAuthed, tier, userId, email, userName }
prompts:   { saved: SavedPrompt[], lastPromptId }
savedWorkflowResults: WorkflowResult[]   // max 10, newest first
```

Key actions: `savePrompt`, `saveWorkflowResult`, `setAuth`, `logout`, `incrementEnhance`

---

## Key Routes

| Path | Component | Notes |
|------|-----------|-------|
| `/` | `LandingPage` | Main enhance flow (inline API call) |
| `/processing` | `ProcessingPage` | Animation only, navigates to `/results` |
| `/app/workflow-processing` | `ProcessingPage useWorkflow` | Calls workflow engine, reads `location.state.input` |
| `/app` | `CommandCenter` | Authenticated app shell |
| `/app/input` | `PromptInputPage` | |
| `/app/library` | `PromptLibrary` | |
| `/app/history` | `HistoryPage` | |
| `/app/workflows` | redirects to `/app` | Placeholder |

---

## Triggering the Workflow Flow

```ts
navigate('/app/workflow-processing', { state: { input: 'your raw prompt' } });
// Result stored in usePilotStore.savedWorkflowResults[0] after completion
```

---

## Environment Variables (Supabase Secrets)

```
ANTHROPIC_API_KEY    — required by both server and workflow-engine functions
ANTHROPIC_MODEL      — optional, defaults to claude-sonnet-4-6
```

Set with: `supabase secrets set ANTHROPIC_API_KEY=sk-ant-...`

---

## What's Already Done
- [x] Migrated `server` function from OpenAI to Anthropic Claude
- [x] Built `workflow-engine` function (multi-step chaining)
- [x] `WorkflowResult` type + `saveWorkflowResult` action in store
- [x] `src/app/utils/workflowApi.ts` with `executeWorkflow` + `SAMPLE_WORKFLOW`
- [x] `ProcessingPage` updated with `useWorkflow` prop
- [x] `/app/workflow-processing` route wired up

---

## What's Next

### Immediate
- [ ] Surface workflow results in the UI (a `WorkflowResultsPage` or panel in `HistoryPage`)
- [ ] Wire a trigger in the app that navigates to `/app/workflow-processing` with real input
- [ ] Add error state to `ProcessingPage` (currently always navigates to `/results` even on failure)

### Medium Term
- [ ] Store workflow definitions in Supabase DB (not hardcoded)
- [ ] SSE streaming — show each step result as it arrives instead of waiting for all
- [ ] Let Claude classify intent instead of keyword rules in `server/index.tsx`
- [ ] Workflow builder UI (drag/drop steps, custom templates)

### Upgrade Path
```
Prototype (now)           → Full Architecture (later)
─────────────────────────────────────────────────────
Hardcoded workflows       → Workflows stored in Supabase DB
SessionStorage state      → Proper workflow history/library
Single enhance call       → Multi-step chain execution
No streaming              → SSE streaming per step
Manual intent detection   → Claude classifies intent itself
```
